create trigger $$COMPANIA$$.tD_PRESUPUESTO_CR on $$COMPANIA$$.PRESUPUESTO_CR for DELETE as
/* ERwin Builtin Tue Mar 21 11:11:24 2000 */
/* DELETE trigger on PRESUPUESTO_CR */
begin
  declare  @errno   int,
           @errmsg  VARCHAR(255)
   
   /* Tabla:DETALLE_PRESUP */
    /* ERwin Builtin Tue Mar 21 11:11:24 2000 */
    /* PRESUPUESTO_CR DETPRPPRP DETALLE_PRESUP ON PARENT DELETE CASCADE */
    delete DETALLE_PRESUP
      from $$COMPANIA$$.DETALLE_PRESUP,deleted
      where
        /*  %JoinFKPK(DETALLE_PRESUP,deleted," = "," and") */
        $$COMPANIA$$.DETALLE_PRESUP.PRESUPUESTO = deleted.PRESUPUESTO
 
     /* ERwin Builtin Tue Mar 21 11:11:24 2000 */
    return
error:
    raiserror (@errno, @errmsg, 0)
    rollback transaction
end;


CREATE PROCEDURE $$COMPANIA$$.GETMONTOPRESUPUESTO (@PRESUPUESTO AS NVARCHAR(MAX),@CENTRO_COSTO AS NVARCHAR(MAX),@PARTIDA AS NVARCHAR(MAX),@RUBRO AS NVARCHAR(MAX),
 @PERIODO AS DATETIME,@REFERENCIA AS NVARCHAR(3),@TIPODATO AS VARCHAR(3))
 AS
 BEGIN
 /*VARIABLES*/
 DECLARE @WHERE AS NVARCHAR(MAX) /* WHERE DE LA SENTENCIA SQL*/
 DECLARE @SQL AS NVARCHAR(MAX) /*SELECT DE LA SENTECIA SQL */
 DECLARE @CONDICION AS NVARCHAR(MAX) /* CONDICION POR SI ES ACUMULADO O NO */
 DECLARE @SUM AS NVARCHAR(MAX) /*SE AGREGA EL SUM O NO SI REFERENCIA ES ACUMULADO(A)*/
 DECLARE @CENTROWHERE AS NVARCHAR(MAX) /* AGREGA LOS CENTRO DE COSTOS A BUSCAR O COMPARAR */
 
 SET @WHERE = ' FROM $$COMPANIA$$.DETALLE_PRESUP WHERE PRESUPUESTO = '''+@PRESUPUESTO+''' AND PERIODO '
 
 IF @REFERENCIA = 'A' 
 BEGIN
 SET @CONDICION = '<= '''+CONVERT(NVARCHAR(75),@PERIODO)+''''
 SET @SUM = 'SUM('
 END
 ELSE
 BEGIN
 SET @CONDICION = '= '''+CONVERT(NVARCHAR(75),@PERIODO)+''''
 SET @SUM = 'SUM('
 END
 /*AUTORIZADO ORIGINAL*/
 IF @RUBRO = 'PAO'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT ISNULL('+@SUM+'MONTO_LOCAL),0)'
 ELSE
 SET @SQL= 'SELECT ISNULL('+@SUM+'MONTO_UDS),0)'
 END
 /*AMPLIACION*/
 ELSE IF @RUBRO = 'PA'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT ISNULL('+@SUM+'AMPLIACION_LOCAL),0)'
 ELSE
 SET @SQL= 'SELECT ISNULL('+@SUM+'AMPLIACION_UDS),0)'
 END 
 /*REDUCCION */
 ELSE IF @RUBRO = 'PR'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT ISNULL('+@SUM+'REDUCCION_LOCAL),0)'
 ELSE
 SET @SQL= 'SELECT ISNULL('+@SUM+'REDUCCION_UDS),0)'
 END 
 /*COMPROMETIDO*/
 ELSE IF @RUBRO = 'PC'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT ISNULL('+@SUM+'COMPR_LOCAL),0)'
 ELSE
 SET @SQL= 'SELECT ISNULL('+@SUM+'COMPR_UDS),0)'
 END
 /*EJERCIDO DEVENGADO */ 
 ELSE IF @RUBRO = 'PED'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT ISNULL('+@SUM+'EJEDEV_LOCAL),0)'
 ELSE
 SET @SQL='SELECT ISNULL('+@SUM+'EJEDEV_UDS),0)'
 END 
 /*PAGADO COBRADO */
 ELSE IF @RUBRO = 'PPC'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT ISNULL('+@SUM+'PAGCOB_LOCAL),0)'
 ELSE
 SET @SQL='SELECT ISNULL('+@SUM+'PAGCOB_UDS),0)'
 END 
 /*AUTOIZADO MODIFICADO */
 ELSE IF @RUBRO = 'PAM'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT '+@SUM+'ISNULL(MONTO_LOCAL,0)+ISNULL(AMPLIACION_LOCAL,0)+ISNULL(REDUCCION_LOCAL,0))'
 ELSE
 SET @SQL='SELECT '+@SUM+'ISNULL(MONTO_UDS,0)+ISNULL(AMPLIACION_UDS,0)+ISNULL(REDUCCION_UDS,0))'
 END
 /* EJERCER RECIBIR */
 ELSE IF @RUBRO = 'PER'
 BEGIN
 IF @TIPODATO = 'M'
 SET @SQL='SELECT '+@SUM+'(ISNULL(MONTO_LOCAL,0)+ISNULL(AMPLIACION_LOCAL,0)+ISNULL(REDUCCION_LOCAL,0)-ISNULL(PAGCOB_LOCAL,0)-ISNULL(COMPR_LOCAL,0)-ISNULL(EJEDEV_LOCAL,0)))'
 ELSE
 SET @SQL='SELECT '+@SUM+'(ISNULL(MONTO_UDS,0)+ISNULL(AMPLIACION_UDS,0)+ISNULL(REDUCCION_UDS,0)-ISNULL(PAGCOB_UDS,0)-ISNULL(COMPR_UDS,0)-ISNULL(EJEDEV_UDS,0)))'
 END 
 /*TERMINAR DE CREAR LA SENTENCIA CON EL WHERE Y EJECUTARLA*/
 SET @SQL += @WHERE + @CONDICION + @CENTRO_COSTO + @PARTIDA
 EXECUTE SP_EXECUTESQL @SQL 
 END;


REMARK 
\
 ------------------------------------------------------------------
 SE INSERTA UN PROCEDIMIENTO PARA LA MACRO DE CR
 ------------------------------------------------------------------
/


CREATE PROCEDURE $$COMPANIA$$.GETSALDOCUENTA(@PRESUPUESTO AS NVARCHAR(100),@PERIODO AS DATETIME, @WHERE AS NVARCHAR(MAX),@MONEDA AS NVARCHAR(3),@REFERENCIA AS NVARCHAR(3))
AS
BEGIN
DECLARE @MONTOINICIAL AS DECIMAL(28,8),@CUENTACONTABLE as NVARCHAR(50),@CENTROCOSTO as NVARCHAR(50),@FECHAINI as DATETIME
DECLARE @SQL AS NVARCHAR(MAX)		
DECLARE @SELECT AS NVARCHAR(MAX)
DECLARE @FROM AS NVARCHAR(MAX)
DECLARE @RESTRICIONES AS VARCHAR(MAX)
DECLARE @ANO_MES AS VARCHAR (MAX)

IF @MONEDA = 'L'
	SET @SELECT = 'SELECT SUM(ISNULL(DEBITO_LOCAL,0) - ISNULL(CREDITO_LOCAL,0))'
ELSE
	SET @SELECT ='SELECT SUM(ISNULL(DEBITO_DOLAR,0) - ISNULL(CREDITO_DOLAR,0))'

SET @FROM = 'FROM $$COMPANIA$$.MAYOR M (NOLOCK)'

IF @REFERENCIA = 'A'
BEGIN
	SELECT @FECHAINI = PERIODO_INICIAL FROM $$COMPANIA$$.PRESUPUESTO_CR WHERE PRESUPUESTO = @PRESUPUESTO
END
ELSE
BEGIN
	SELECT  @FECHAINI = MAX(PERIODO) FROM $$COMPANIA$$.DETALLE_PRESUP where PERIODO < @PERIODO
	SET @FECHAINI= DATEADD(DAY,1,@FECHAINI)
END		
SET @RESTRICIONES = 'WHERE FECHA >= '''+CONVERT(NVARCHAR(75),@FECHAINI)+''' AND FECHA <= '''+CONVERT(NVARCHAR(75),@PERIODO)+''''	

SET @SQL =@SELECT+@FROM+@RESTRICIONES+ @WHERE 
EXECUTE SP_EXECUTESQL @SQL	
END;


CREATE FUNCTION $$COMPANIA$$.GETDESCRIPCION
  (@OPCION AS INT, @PARAM_CCN AS VARCHAR(25), @TIPO_CONTABILIDAD AS VARCHAR(1)) 
  RETURNS VARCHAR(254)
  BEGIN 
  DECLARE @DESCRIPCION AS VARCHAR(254)
   IF @OPCION = 1  
   BEGIN   
    SELECT @DESCRIPCION = DESCRIPCION    
     FROM $$COMPANIA$$.CENTRO_COSTO    
     WHERE CENTRO_COSTO = @PARAM_CCN  
   END 
   ELSE IF @OPCION = 2  
	BEGIN 
		IF @TIPO_CONTABILIDAD = 'C' 
			BEGIN 
				SELECT @DESCRIPCION = DESCRIPCION_IFRS
				FROM $$COMPANIA$$.CUENTA_CONTABLE    
				WHERE CUENTA_CONTABLE = @PARAM_CCN  
			END
		ELSE 
			BEGIN 
				SELECT @DESCRIPCION = DESCRIPCION
				FROM $$COMPANIA$$.CUENTA_CONTABLE    
				WHERE CUENTA_CONTABLE = @PARAM_CCN  
			END
	END 
   ELSE IF @OPCION = 3  
   BEGIN
    SELECT @DESCRIPCION = RAZON_SOCIAL    
    FROM $$COMPANIA$$.NIT    
    WHERE NIT  = @PARAM_CCN  
   END 
   ELSE IF @OPCION = 4  
   BEGIN   
    SELECT @DESCRIPCION = DESCRIPCION    
    FROM $$COMPANIA$$.PRESUPUESTO    
    WHERE PRESUPUESTO  = @PARAM_CCN  
   END 
    ELSE IF @OPCION = 6    
   BEGIN   
    SELECT @DESCRIPCION = DESCRIPCION    
    FROM $$COMPANIA$$.PARTIDA_CR    
    WHERE PARTIDA  = @PARAM_CCN  
   END 
   ELSE IF @OPCION = 7    
   BEGIN   
    SELECT @DESCRIPCION = DESCRIPCION    
    FROM $$COMPANIA$$.CENTRO_COSTO_CR    
    WHERE CENTRO_COSTO  = @PARAM_CCN  
   END 
   ELSE   
   BEGIN   
    SET @DESCRIPCION = 'NO DISPONIBLE'  
   END     
  
  RETURN (ISNULL(@DESCRIPCION,''))
  END;