CREATE VIEW $$COMPANIA$$.V_DOCUMENTO_ELECTRONICO_DE
 AS 
  	  SELECT
	 (CASE WHEN (FAC.OBSERVACIONES like '%Cargado del POS%' AND FAC.TIPO_DOCUMENTO = 'F') 
	 THEN 'T' ELSE FAC.TIPO_DOCUMENTO END) AS TIPODOCUMENTO, 	 
  	 FAC.FACTURA AS FACTURA, 
  	 FAC.ANULADA AS ANULADA, 
  	 FAC.CLIENTE AS CLIENTE,
  	 DOCELECTPROC.ESTADO AS ESTADO, 
  	 FAC.TOTAL_FACTURA AS TOTALFACTURA,
  	 ( SELECT SUM(MONTO) 
  	 FROM (
  	 SELECT TOTAL_FACTURA AS MONTO FROM $$COMPANIA$$.FACTURA WHERE FACTURA=FAC.FACTURA 
  	 AND TIPO_DOCUMENTO = FAC.TIPO_DOCUMENTO 
  	 UNION ALL
  	 SELECT - (MONTO) AS MONTO FROM $$COMPANIA$$.FACTURA_RETENCION WHERE FACTURA=FAC.FACTURA
  	 AND TIPO_DOCUMENTO = FAC.TIPO_DOCUMENTO
  	 ) AS T
  	 ) AS TOTALFACTURARETENCION,
  	 FAC.FECHA AS FECHA, 
  	 FAC.MONEDA_FACTURA AS MONEDAFACTURA,
	 FAC.TOTAL_IMPUESTO1, 
	 FAC.TOTAL_IMPUESTO2,
	 FAC.MONTO_DESCUENTO1,
	 FAC.MONTO_DESCUENTO2,
  	 CONVERT(CHAR(36),LOWER(FAC.ROWPOINTER)) AS ROWPOINTER,
  	 'FACTURA' AS TABLA,
  	 FAC.RECORDDATE,
  	 FAC.CREATEDBY,
  	 FAC.UPDATEDBY,
  	 FAC.CREATEDATE,
  	 DOCELECTPROC.FOLIO_SAT AS FOLIOSAT,
  	 ISNULL(DOCELECTPROC.ENVIADO,'N') AS ENVIADO,
  	 DOCELECTPROC.NIT_EMISOR AS NIT_EMISOR,
  	 DOCELECTPROC.NIT_RECEPTOR AS NIT_RECEPTOR,
  	 ISNULL(DOCELECTPROC.ACEPTADO,'P') AS ACEPTADO,
  	 DOCELECTPROC.ACEPTACION_RECHAZO AS ACEPTACION_RECHAZO,
  	 DOCELECTPROC.DOCUMENTO_ELECTRONICO AS DOCUMENTO_ELECTRONICO,
  	 DOCELECTPROC.NOMBRE_PDF AS NOMBRE_PDF,
  	 DOCELECTPROC.NOMBRE_XML AS NOMBRE_XML,
  	 DOCELECTPROC.ESTADO_CARTA_PORTE AS ESTADO_CARTA_PORTE,
  	 DOCELECTPROC.GENERA_CARTA_PORTE AS GENERA_CARTA_PORTE,
  	 DOCELECTPROC.ERROR_WS AS ERROR_WS,
  	 DOCELECTPROC.ERROR_SOFTLAND AS ERROR_SOFTLAND,
  	 FAC.DOC_FISCAL AS DOCUMENTO_FISCAL,
  	 DOCELECTPROC.FIRMA_DOCUMENTO AS FIRMA_GT,
  	 DOCELECTPROC.GUUID_GT AS GUUID_GT,
	 DOCELECTPROC.XML_RESPUESTA AS XML_RESPUESTA,
	 DOCELECTPROC.PDF_ARCHIVO AS PDF_ARCHIVO,
	 DOCELECTPROC.LINK_CONSULTA AS LINK_CONSULTA,
	 DOCELECTPROC.EMAIL_EMISOR AS EMAIL_EMISOR,
	 DOCELECTPROC.EMAIL_RECEPTOR AS EMAIL_RECEPTOR,
	 DOCELECTPROC.SELLOSAT AS SELLOSAT
  	 FROM $$COMPANIA$$.FACTURA FAC 
  	 LEFT OUTER JOIN $$COMPANIA$$.DOC_ELECTRONICO_PROC_DE DOCELECTPROC 
  	 ON (DOCELECTPROC.TIPO_DOC = FAC.TIPO_DOCUMENTO OR
	 (DOCELECTPROC.TIPO_DOC = 'T' AND FAC.TIPO_DOCUMENTO = 'F'))
  	 AND DOCELECTPROC.NUMERO_DOC = FAC.FACTURA 
  	 WHERE ( FAC.TIPO_DOCUMENTO != 'R' AND FAC.GENERA_DOC_FE = 'S')
	 AND FAC.FECHA >= (SELECT CONVERT(DATE, CONVERT( varchar(30),VALOR) ,103) FROM erpadmin.GLOBALES_DE WHERE NOMBRE = '$$COMPANIA$$_FECHA_INICIO')
  	 UNION ALL
  	 SELECT (CASE D.TIPO WHEN 'FAC' THEN 'F' WHEN 'N/C' THEN 'D' WHEN 'N/D' THEN 'ND' END) AS TIPODOCUMENTO, 
  	 D.DOCUMENTO AS FACTURA, 
  	 D.ANULADO AS ANULADA,
  	 D.CLIENTE AS CLIENTE,
  	 DOCELECTPROC.ESTADO AS ESTADO, 
  	 D.MONTO AS TOTALFACTURA,
  	 ( SELECT SUM(MONTO) 
  	 FROM ( 
  	 SELECT D.MONTO AS MONTO 
  	 FROM $$COMPANIA$$.DOCUMENTOS_CC 
  	 WHERE DOCUMENTO=D.DOCUMENTO 
  	 AND TIPO = D.TIPO
  	 UNION ALL
  	 SELECT - (MONTO) AS MONTO 
  	 FROM $$COMPANIA$$.RETENCIONES_DOC_CC 
  	 WHERE DOCUMENTO=D.DOCUMENTO
  	 AND TIPO = D.TIPO
  	 ) AS T
  	 ) AS TOTALFACTURARETENCION,
  	 D.FECHA AS FECHA, 
  	 'L' AS MONEDAFACTURA, 
	 D.IMPUESTO1 TOTAL_IMPUESTO1,
	 D.IMPUESTO2 TOTAL_IMPUESTO2,
	 D.DESCUENTO MONTO_DESCUENTO1,
	 0 MONTO_DESCUENTO2,
  	 CONVERT(CHAR(36),LOWER(D.ROWPOINTER)) AS ROWPOINTER,
  	 'DOCUMENTOS_CC' AS TABLA,
  	 D.RECORDDATE,
  	 D.CREATEDBY,
  	 D.UPDATEDBY,
  	 D.CREATEDATE,
  	 DOCELECTPROC.FOLIO_SAT AS FOLIOSAT,
  	 ISNULL(DOCELECTPROC.ENVIADO,'N') AS ENVIADO,
  	 DOCELECTPROC.NIT_EMISOR AS NIT_EMISOR,
  	 DOCELECTPROC.NIT_RECEPTOR AS NIT_RECEPTOR,
  	 ISNULL(DOCELECTPROC.ACEPTADO,'N') AS ACEPTADO,
  	 DOCELECTPROC.ACEPTACION_RECHAZO AS ACEPTACION_RECHAZO,
  	 DOCELECTPROC.DOCUMENTO_ELECTRONICO AS DOCUMENTO_ELECTRONICO,
  	 DOCELECTPROC.NOMBRE_PDF AS NOMBRE_PDF,
  	 DOCELECTPROC.NOMBRE_XML AS NOMBRE_XML,
  	 DOCELECTPROC.ESTADO_CARTA_PORTE AS ESTADO_CARTA_PORTE,
  	 DOCELECTPROC.GENERA_CARTA_PORTE AS GENERA_CARTA_PORTE,
  	 DOCELECTPROC.ERROR_WS AS ERROR_WS,
  	 DOCELECTPROC.ERROR_SOFTLAND AS ERROR_SOFTLAND,
  	 D.DOCUMENTO_FISCAL AS DOCUMENTO_FISCAL,
  	 DOCELECTPROC.FIRMA_DOCUMENTO AS FIRMA_GT,
  	 DOCELECTPROC.GUUID_GT AS GUUID_GT,
	 DOCELECTPROC.XML_RESPUESTA AS XML_RESPUESTA,
	 DOCELECTPROC.PDF_ARCHIVO AS PDF_ARCHIVO,
	 DOCELECTPROC.LINK_CONSULTA AS LINK_CONSULTA,
	 DOCELECTPROC.EMAIL_EMISOR AS EMAIL_EMISOR,
	 DOCELECTPROC.EMAIL_RECEPTOR AS EMAIL_RECEPTOR,
	 DOCELECTPROC.SELLOSAT AS SELLOSAT
  	 FROM $$COMPANIA$$.DOCUMENTOS_CC D
  	 LEFT OUTER JOIN $$COMPANIA$$.DOC_ELECTRONICO_PROC_DE DOCELECTPROC 
  	 ON DOCELECTPROC.TIPO_DOC = (CASE D.TIPO WHEN 'FAC' THEN 'F' WHEN 'N/C' THEN 'D' WHEN 'N/D' THEN 'ND' END)
  	 AND DOCELECTPROC.NUMERO_DOC = D.DOCUMENTO 
  	 WHERE D.TIPO IN ('FAC','N/C','N/D') 
  	 AND D.GENERA_DOC_FE = 'S' 
  	 AND 0 = ( 
  	 SELECT COUNT(0) FROM 
  	 $$COMPANIA$$.FACTURA F 
  	 WHERE D.DOCUMENTO = F.FACTURA 
	 AND D.TIPO = ( CASE F.TIPO_DOCUMENTO WHEN 'F' THEN 'FAC' WHEN 'D' THEN 'N/C' END))
	 AND D.FECHA >=(SELECT CONVERT(DATE, CONVERT( varchar(30),VALOR) ,103) FROM erpadmin.GLOBALES_DE WHERE NOMBRE = '$$COMPANIA$$_FECHA_INICIO');	
	 
	 
CREATE VIEW $$COMPANIA$$.V_FACTURA
AS 
SELECT
F.FACTURA DOCUMENTO,
ISNULL(F.DOC_FISCAL, 'CAMPO EN BLANCO') AS DOC_FISCAL,
F.CONDICION_PAGO,
F.CLIENTE,
F.SERIE_RESOLUCION,
F.CONSEC_RESOLUCION,
CP.DESCRIPCION DESCRIPCION_CONDICION_PAGO,
F.DIREC_EMBARQUE,
F.CONSECUTIVO,
DE.CONTACTO,
DE.CARGO,
DE.TELEFONO1,
DE.TELEFONO2,
DE.FAX,
DE.EMAIL,
DD.CAMPO_1 DIREC_CAMPO_1,
DD.CAMPO_2 DIREC_CAMPO_2,
DD.CAMPO_3 DIREC_CAMPO_3,
DD.CAMPO_4 DIREC_CAMPO_4,
DD.CAMPO_5 DIREC_CAMPO_5,
DD.CAMPO_6 DIREC_CAMPO_6,
DD.CAMPO_7 DIREC_CAMPO_7,
DD.CAMPO_8 DIREC_CAMPO_8,
DD.CAMPO_9 DIREC_CAMPO_9,
DD.CAMPO_10 DIREC_CAMPO_10,
CONVERT(varchar(10),F.FECHA_HORA,126) AS FECHA,
CONVERT(varchar(10),F.FECHA_HORA,108) AS HORA, 
CONVERT(varchar(10),F.FECHA_ORDEN,126) AS FECHA_ORDEN,
CONVERT(varchar(10),F.FECHA_ORDEN,108) AS HORA_ORDEN, 
F.MONEDA_FACTURA,
CAST (F.MONTO_ANTICIPO AS DECIMAL(28,6)) AS MONTO_ANTICIPO,
CAST (F.MONTO_COBRADO AS DECIMAL(28,6)) AS MONTO_COBRADO,
CAST (F.MONTO_DESCUENTO1 AS DECIMAL(28,6)) AS MONTO_DESCUENTO1,
CAST (F.MONTO_DESCUENTO2 AS DECIMAL(28,6)) AS MONTO_DESCUENTO2,
CAST (F.MONTO_DOCUMENTACIO AS DECIMAL(28,6)) AS MONTO_DOCUMENTACIO,
CAST (F.MONTO_FLETE AS DECIMAL(28,6)) AS MONTO_FLETE,
CAST (F.MONTO_SEGURO AS DECIMAL(28,6)) AS MONTO_SEGURO,
F.ORDEN_COMPRA,
CAST (F.PORC_DESCUENTO1 AS DECIMAL(28,6)) AS PORC_DESCUENTO1,
CAST (F.PORC_DESCUENTO2 AS DECIMAL(28,6)) AS PORC_DESCUENTO2,
F.RUBRO1,
F.RUBRO2,
F.RUBRO3,
F.RUBRO4,
F.RUBRO5,
F.COMENTARIO_CXC,
(CASE F.MONEDA_FACTURA WHEN 'L' THEN '1' WHEN 'D' THEN F.TIPO_CAMBIO END) AS TIPO_CAMBIO,
(CASE WHEN (F.OBSERVACIONES like '%Cargado del POS%' AND F.TIPO_DOCUMENTO = 'F') 
	 THEN 'T' ELSE F.TIPO_DOCUMENTO END) AS TIPO_DOCUMENTO,
CAST (F.TOTAL_FACTURA AS DECIMAL(28,6)) AS TOTAL_FACTURA,
$$COMPANIA$$.NUMEROALETRAS(F.TOTAL_FACTURA) AS TOTAL_FACTURA_LETRAS,
CAST (F.TOTAL_FACTURA - ISNULL(FR.MONTO,0) AS DECIMAL(28,6)) AS TOTAL_FACTURA_SIN_RETENCION,
$$COMPANIA$$.NUMEROALETRAS(F.TOTAL_FACTURA - ISNULL(FR.MONTO,0)) AS TOT_FAC_SIN_RETENCION_LETRAS,
CAST (F.TOTAL_MERCADERIA AS DECIMAL(28,6)) AS SUBTOTAL_FACTURA,
$$COMPANIA$$.NUMEROALETRAS(F.TOTAL_MERCADERIA) AS SUBTOTAL_FACTURA_LETRAS,
CAST (F.TOTAL_UNIDADES AS DECIMAL(28,6)) AS TOTAL_UNIDADES,
CAST (F.TOTAL_IMPUESTO1 AS DECIMAL(28,6)) AS TOTAL_IMPUESTO1,
CAST (F.TOTAL_IMPUESTO2 AS DECIMAL(28,6)) AS TOTAL_IMPUESTO2,
F.VENDEDOR,
F.OBSERVACIONES,
CAST (ISNULL(RT.PORCENTAJE,0) AS DECIMAL(28,6)) AS RETENCION_PORCENTAJE,      
CAST (ISNULL(FR.MONTO,0) AS DECIMAL(28,6)) AS RETENCION_MONTO,
F.ANULADA,
ISNULL(F.PEDIDO, 'CAMPO EN BLANCO') AS PEDIDO,
ISNULL(F.FACTURA_ORIGINAL, 'CAMPO EN BLANCO') AS FACTURA_ORIGINAL,
ISNULL(P.BODEGA, 'CAMPO EN BLANCO') AS PEDIDO_BODEGA,
R.FECHA AS FECHA_ORIGINAL,
DATEADD(S,DATEPART(S,R.CREATEDATE),DATEADD(MI,DATEPART(MI,R.CREATEDATE),DATEADD(HH,DATEPART(HH,R.CREATEDATE),R.FECHA))) FECHA_HORA_ORIGINAL,
DC.FECHA_VENCE,
P.FECHA_PROMETIDA,
CAST ((F.MONTO_DESCUENTO1 + F.MONTO_DESCUENTO2 + F.DESCUENTO_VOLUMEN + (SELECT ISNULL( SUM(FL1.DESC_TOT_LINEA),0) FROM $$COMPANIA$$.FACTURA_LINEA FL1 WHERE FL1.FACTURA = F.FACTURA AND FL1.TIPO_DOCUMENTO = F.TIPO_DOCUMENTO)) AS DECIMAL(28,6)) AS TOTAL_DESCUENTOS
FROM $$COMPANIA$$.FACTURA F
LEFT JOIN $$COMPANIA$$.FACTURA_RETENCION FR 
ON F.FACTURA =  FR.FACTURA AND F.TIPO_DOCUMENTO = FR.TIPO_DOCUMENTO
LEFT JOIN $$COMPANIA$$.RETENCIONES RT
ON FR.CODIGO_RETENCION = RT.CODIGO_RETENCION
LEFT JOIN $$COMPANIA$$.PEDIDO P
ON P.PEDIDO = F.PEDIDO
LEFT JOIN $$COMPANIA$$.FACTURA R
ON R.FACTURA = F.FACTURA_ORIGINAL AND R.TIPO_DOCUMENTO = F.TIPO_ORIGINAL
LEFT JOIN $$COMPANIA$$.DOCUMENTOS_CC DC
ON DC.DOCUMENTO = F.FACTURA AND (CASE DC.TIPO WHEN 'FAC' THEN 'F' WHEN 'N/C' THEN 'D' END) = F.TIPO_DOCUMENTO
LEFT JOIN $$COMPANIA$$.DIRECC_EMBARQUE DE
ON F.CLIENTE = DE.CLIENTE AND F.DIREC_EMBARQUE = DE.DIRECCION
LEFT JOIN $$COMPANIA$$.DETALLE_DIRECCION DD
ON DE.DETALLE_DIRECCION = DD.DETALLE_DIRECCION
LEFT JOIN $$COMPANIA$$.CONDICION_PAGO CP
ON CP.CONDICION_PAGO = F.CONDICION_PAGO
UNION ALL

SELECT 
DCC.DOCUMENTO,
ISNULL(DCC.DOCUMENTO_FISCAL,'CAMPO EN BLANCO') DOCUMENTO_FISCAL,
DCC.CONDICION_PAGO,
DCC.CLIENTE,
'CAMPO EN BLANCO' as 'SERIE_RESOLUCION',
0 as 'CONSEC_RESOLUCION',
CP.DESCRIPCION DESCRIPCION_CONDICION_PAGO,
'' DIRECCION,
'CONSEC_CC' CONSECUTIVO,
'ND' CONTACTO,
'ND' CARGO,
'ND' TELEFONO1,
'ND' TELEFONO2,
'ND' FAX,
'ND' EMAIL,
'ND'  DIREC_CAMPO_1,
'ND' DIREC_CAMPO_2,
'ND' DIREC_CAMPO_3,
'ND' DIREC_CAMPO_4,
'ND' DIREC_CAMPO_5,
'ND' DIREC_CAMPO_6,
'ND' DIREC_CAMPO_7,
'ND' DIREC_CAMPO_8,
'ND' DIREC_CAMPO_9,
'ND' DIREC_CAMPO_10,
CONVERT(varchar(10),DCC.FECHA,126) AS FECHA,
CONVERT(varchar(10),DCC.CREATEDATE,108) AS HORA, 
/* DATEADD(S,DATEPART(S,DCC.CREATEDATE),DATEADD(MI,DATEPART(MI,DCC.CREATEDATE),DATEADD(HH,DATEPART(HH,DCC.CREATEDATE),DCC.FECHA))) FECHA_HORA,*/
CONVERT(varchar(10),DCC.FECHA_DOCUMENTO,126) AS FECHA_ORDEN,
CONVERT(varchar(10),DCC.CREATEDATE,108) AS HORA_ORDEN,
/*DATEADD(S,DATEPART(S,DCC.CREATEDATE),DATEADD(MI,DATEPART(MI,DCC.CREATEDATE),DATEADD(HH,DATEPART(HH,DCC.CREATEDATE),DCC.FECHA))) FECHA_HORA,*/
DCC.MONEDA,
'0.000000' ANTICIPO,
'0.000000' COBRADO,
'0.000000' DESCUENTO1,
'0.000000' DESCUENTO2,
'0.000000' DOCUMENTACIO,
CAST (DCC.RUBRO1 AS DECIMAL(28,6)) AS MONTO_FLETE,
CAST (DCC.RUBRO2 AS DECIMAL(28,6)) AS SEGURO,
'N/D' ORDEN_COMPRA,
'0.000000' PORC_DESCUENTO1,
'0.000000' PORC_DESCUENTO2,
NULL RUBRO1,
NULL RUBRO2,
NULL RUBRO3,
NULL RUBRO4,
NULL RUBRO5,
NULL COMENTARIO_CXC,
CAST (DCC.TIPO_CAMBIO_MONEDA AS DECIMAL(28,6)) AS TIPO_CAMBIO,
(CASE DCC.TIPO WHEN 'FAC' THEN 'F' WHEN 'N/C' THEN 'D' WHEN 'N/D' THEN 'ND' END) AS TIPO_DOCUMENTO,
CAST (DCC.MONTO AS DECIMAL(28,6)) AS TOTAL_FACTURA,
$$COMPANIA$$.NUMEROALETRAS(DCC.MONTO) AS TOTAL_FACTURA_LETRAS,
CAST (DCC.MONTO - ISNULL(DCC.MONTO_RETENCION,0) AS DECIMAL(28,6)) AS TOTAL_FACTURA_SIN_RETENCION,
$$COMPANIA$$.NUMEROALETRAS(DCC.MONTO - ISNULL(DCC.MONTO_RETENCION,0)) AS TOT_FAC_SIN_RETENCION_LETRAS,
CAST (DCC.SUBTOTAL AS DECIMAL(28,6)) AS SUBTOTAL_FACTURA,
$$COMPANIA$$.NUMEROALETRAS(DCC.MONTO) AS SUBTOTAL_FACTURA_LETRAS,
CAST ('1' AS DECIMAL(28,6)) AS TOTAL_UNIDADES,

/*CAST (DCC.IMPUESTO1 AS DECIMAL(28,6)),*/
   CASE WHEN IMP.CALCULO_IMP2 = 'I' THEN (DCC.MONTO / (1 + (IMP.IMPUESTO1/ 100 + IMP.IMPUESTO2/ 100 + IMP.IMPUESTO1/ 100 * IMP.IMPUESTO2/ 100) )) * (IMP.IMPUESTO1/100) 
   ELSE (((DCC.MONTO / (1 + ((IMP.IMPUESTO1 + IMP.IMPUESTO2 ) / 100 )))) * (IMP.IMPUESTO1 / 100 ) ) END AS IMPUESTO1,
/*CAST (DCC.IMPUESTO2 AS DECIMAL(28,6)),*/
   CASE 
	   WHEN IMP.USA_IMPUESTO2_CANTIDAD = 'S' THEN DCC.IMPUESTO2  
	   WHEN IMP.CALCULO_IMP2 = 'S' THEN (((DCC.MONTO / (1 + ((IMP.IMPUESTO1 + IMP.IMPUESTO2 ) / 100 )))) * (IMP.IMPUESTO2 / 100 ) )
	   WHEN IMP.CALCULO_IMP2 = 'I' THEN (DCC.MONTO / (1 + (IMP.IMPUESTO1/ 100 + IMP.IMPUESTO2/ 100 + IMP.IMPUESTO1/ 100 * IMP.IMPUESTO2/ 100) )) *(IMP.IMPUESTO2)
	   ELSE 0
	   END AS IMPUESTO2,

DCC.VENDEDOR,
'SIN OBSERVACIONES' OBSERVACIONES,
CAST (ISNULL(RT.PORCENTAJE,0) AS DECIMAL(28,6)) AS RETENCION_PORCENTAJE,      
CAST (ISNULL(FR.MONTO,0) AS DECIMAL(28,6)) AS RETENCION_MONTO,
DCC.ANULADO,
'N/D' PEDIDO,
ISNULL(DCC.DOCUMENTO, 'CAMPO EN BLANCO') AS FACTURA_ORIGINAL,
'N/D' BODEGA,
(CONVERT(DATETIME,DCC.FECHA,126)) AS FECHA,
(CONVERT(DATETIME,DCC.FECHA,114)) AS HORA, 
DCC.FECHA_VENCE,
DCC.FECHA FECHA_PROMETIDA,
CAST (DCC.DESCUENTO AS DECIMAL(28,6)) AS TOTAL_DESCUENTOS
FROM $$COMPANIA$$.DOCUMENTOS_CC DCC
LEFT JOIN $$COMPANIA$$.CONDICION_PAGO CP
ON CP.CONDICION_PAGO = DCC.CONDICION_PAGO
LEFT JOIN $$COMPANIA$$.FACTURA_RETENCION FR 
ON DCC.DOCUMENTO = FR.FACTURA AND DCC.TIPO = FR.TIPO_DOCUMENTO
LEFT JOIN $$COMPANIA$$.RETENCIONES RT
ON FR.CODIGO_RETENCION = RT.CODIGO_RETENCION
LEFT JOIN $$COMPANIA$$.IMPUESTO IMP ON DCC.CODIGO_IMPUESTO = IMP.IMPUESTO
WHERE 0 = (SELECT COUNT(*) FROM $$COMPANIA$$.FACTURA FAC
WHERE DCC.DOCUMENTO = FAC.FACTURA
AND FAC.TIPO_DOCUMENTO =(CASE DCC.TIPO WHEN 'FAC' THEN 'F' WHEN 'N/C' THEN 'D' WHEN 'N/D' THEN 'ND' END));

CREATE VIEW $$COMPANIA$$.V_LINEAS_FE
AS 
--select * from (
   SELECT
   (CASE WHEN (F.OBSERVACIONES like '%Cargado del POS%' AND F.TIPO_DOCUMENTO = 'F') 
	 THEN 'T' ELSE FL.TIPO_DOCUMENTO END) AS TIPO_DOCUMENTO,  
   FL.FACTURA,
   ART.ARTICULO,
   FL.LINEA + 1 LINEA,
   CAST (FL.CANTIDAD AS DECIMAL(28,6)) AS CANTIDAD,
   CAST (FL.PRECIO_UNITARIO AS DECIMAL(28,6)) AS PRECIO_UNITARIO,
   CAST (((FL.PRECIO_UNITARIO * FL.CANTIDAD) - FL.DESC_TOT_LINEA) / FL.CANTIDAD AS DECIMAL(28,6)) AS PRECIO_UNITARIO_DESCONTADO,

   CAST (((FL.PRECIO_UNITARIO * FL.CANTIDAD) - (FL.DESC_TOT_LINEA + FL.DESC_TOT_GENERAL)) / FL.CANTIDAD AS DECIMAL(28,6)) AS PRECIO_UNITARIO_DESC_TOTAL,          
   CAST (CASE 
   WHEN FL.DESCUENTO_VOLUMEN = 0 THEN (FL.DESC_TOT_LINEA / (CASE WHEN(FL.PRECIO_UNITARIO * FL.CANTIDAD)= 0 THEN 1 ELSE FL.PRECIO_UNITARIO END)) * 100  
  ELSE 100 
  END AS DECIMAL(28,6)) AS PORCENTAJE_DESC,
  CAST (CASE 
   WHEN FL.DESCUENTO_VOLUMEN = 0 THEN FL.DESC_TOT_LINEA
  ELSE FL.DESCUENTO_VOLUMEN 
  END AS DECIMAL(28,6)) AS DESC_TOT_LINEA, 
  (FL.DESC_TOT_GENERAL * 100 / (CASE WHEN(FL.PRECIO_TOTAL)= 0 THEN 1 END)) AS PORCENTAJE_DESC_GENERAL_TOTAL, 
   CAST (FL.DESC_TOT_GENERAL AS DECIMAL(28,6)) AS DESC_TOT_GENERAL,
   ART.IMPUESTO,
   CAST (IMP.IMPUESTO1 AS DECIMAL(28,6)) AS IMPUESTO1,     
   CAST (FL.TOTAL_IMPUESTO1 AS DECIMAL(28,6)) AS TOTAL_IMPUESTO1,
   CAST (IMP.IMPUESTO2 AS DECIMAL(28,6)) AS IMPUESTO2,
   CAST (FL.TOTAL_IMPUESTO2 AS DECIMAL(28,6)) AS TOTAL_IMPUESTO2,

   AV.TIPO_DOC CODIGO_EXENTO,
   AV.NOMBRE_INSTITUCION NOMBRE_INSTITUCION,
   AV.NUM_AUTOR NUMERO_EXENTO ,
  convert(varchar,AV.FECHA_RIGE,126) AS EXENTO_FECHA ,   
   IMP.IMPUESTO1 * (1 + ((AV.PORCENTAJE-100)/100 )) AS EXENTO_IMP1 ,
    CASE WHEN C.EXENCION_IMP1 > 0 THEN C.EXENCION_IMP1 ELSE AV.PORCENTAJE END PORCENTAJE_EXENTO ,      
			CASE 
			WHEN FL.TOTAL_IMPUESTO1 > 0 AND C.EXENCION_IMP1 > 0 THEN 
			ISNULL(((FL.PRECIO_UNITARIO * FL.CANTIDAD) - (FL.DESC_TOT_LINEA + FL.DESC_TOT_GENERAL)) * ((IMP.IMPUESTO1 /100) * (C.EXENCION_IMP1/100)) ,0)
			WHEN FL.TOTAL_IMPUESTO1 > 0 THEN
			ISNULL(((FL.PRECIO_UNITARIO * FL.CANTIDAD) - (FL.DESC_TOT_LINEA + FL.DESC_TOT_GENERAL)) * ((IMP.IMPUESTO1 /100) * (AV.PORCENTAJE/100)),0)
			ELSE 0 
		   END   
    AS TOTAL_EXONERADO,
   
   
   FL.PRECIO_UNITARIO * FL.CANTIDAD AS PRECIO_TOTAL_BRUTO,
   CAST (FL.PRECIO_TOTAL AS DECIMAL(28,6)) AS PRECIO_TOTAL,
   ((FL.PRECIO_UNITARIO * FL.CANTIDAD) - (FL.DESC_TOT_LINEA + FL.DESC_TOT_GENERAL)) PRECIO_TOTAL_DESCONTADO,
   CASE 
    WHEN FL.DESCUENTO_VOLUMEN = 0 THEN 
    ((FL.PRECIO_UNITARIO * FL.CANTIDAD) - (FL.DESC_TOT_LINEA + FL.DESC_TOT_GENERAL) + (FL.TOTAL_IMPUESTO1 + FL.TOTAL_IMPUESTO2)) 
    ELSE 0 
   END AS PRECIO_TOTAL_NETO,
   CASE 
    WHEN FL.TOTAL_IMPUESTO1 > 0 THEN 
    ((FL.PRECIO_UNITARIO * FL.CANTIDAD) - (FL.DESC_TOT_LINEA + FL.DESC_TOT_GENERAL)) 
    ELSE 0 
   END AS PRECIO_TOTAL_NETO_GRABADO_IMP1,
   CAST (FL.DESCUENTO_VOLUMEN AS DECIMAL(28,6)) AS DESCUENTO_VOLUMEN,
   FL.SERIE_CADENA,
   FL.TIPO_LINEA AS TIPO_LINEA_KIT,
   P.PEDIMENTO,
   P.FECHA PEDIMENTO_FECHA,           
   A.DESCRIPCION ADUANA_DESCRIPCION,     
   FL.COMENTARIO,
   FL.DESCRIPCION AS DESCRIPCION_LINEA,
   FL.BODEGA,
   FL.LOCALIZACION,
   FL.LOTE,
   CAST (FL.BASE_IMPUESTO1 AS DECIMAL(28,6)) AS BASE_IMPUESTO1,
   CAST (FL.BASE_IMPUESTO2 AS DECIMAL(28,6)) AS BASE_IMPUESTO2,  
   CASE 
    WHEN FL.DESCRIPCION IS NULL OR DATALENGTH(FL.DESCRIPCION) = 0 THEN 
     SUBSTRING(ART.DESCRIPCION,0,69) 
    ELSE 
     SUBSTRING(FL.DESCRIPCION,0,69)  
   END AS DESCRIPCION_ARTICULO,    
   ISNULL(ART.CODIGO_BARRAS_INVT, '00000000000000') AS CODIGO_BARRAS_INVT,
   ISNULL(ART.CODIGO_BARRAS_VENT, '00000000000000') AS CODIGO_BARRAS_VENT,
   ART.FACTOR_EMPAQUE,
   ART.UNIDAD_ALMACEN,
   ART.UNIDAD_EMPAQUE,
   ART.UNIDAD_VENTA,
   UM.U_FEUNIDAD,
   ART.TIPO, 
   ART.ARTICULO_CUENTA,        
   CASE 
    WHEN (FL.TOTAL_IMPUESTO1 > 0) OR (FL.TOTAL_IMPUESTO2 > 0) THEN 'S'  
    ELSE 'N'
   END AS IMPUESTO_AGRUPABLE,
   CASE 
    WHEN (ART.TIPO = 'V') THEN 'S'  
    ELSE 'N'
   END AS TIPO_SERVICIO,
   'S' AS LINEA_AGRUPABLE 
   FROM $$COMPANIA$$.FACTURA_LINEA FL
         LEFT JOIN $$COMPANIA$$.ARTICULO ART ON FL.ARTICULO = ART.ARTICULO
         LEFT JOIN $$COMPANIA$$.IMPUESTO IMP ON IMP.IMPUESTO = ART.IMPUESTO
         LEFT JOIN $$COMPANIA$$.PEDIMENTO_LOTE PL ON FL.LOTE = PL.LOTE AND PL.ARTICULO = ART.ARTICULO
         LEFT JOIN $$COMPANIA$$.PEDIMENTO P ON PL.PEDIMENTO = P.PEDIMENTO 
		 LEFT JOIN $$COMPANIA$$.ADUANA A ON P.ADUANA = A.ADUANA
		 LEFT JOIN $$COMPANIA$$.FACTURA F ON FL.TIPO_DOCUMENTO = F.TIPO_DOCUMENTO AND FL.FACTURA = F.FACTURA 
		 LEFT JOIN $$COMPANIA$$.CLIENTE C ON C.CLIENTE = F.CLIENTE_ORIGEN
		 LEFT JOIN $$COMPANIA$$.UNIDAD_DE_MEDIDA UM ON UM.UNIDAD_MEDIDA = ART.UNIDAD_ALMACEN
		 LEFT JOIN $$COMPANIA$$.CLASIFICACION_VENTA CV  on CV.CODIGO_ARTICULO = FL.ARTICULO  AND CV.CODIGO IN ( SELECT AV.CODIGO FROM $$COMPANIA$$.AUTOR_VENTA AV WHERE AV.CLIENTE = C.CLIENTE ) 
		 LEFT JOIN $$COMPANIA$$.AUTOR_VENTA AV ON  CV.CODIGO = AV.CODIGO 
   UNION ALL
   SELECT
   (CASE DCC.TIPO WHEN 'FAC' THEN 'F' WHEN 'N/C' THEN 'D' WHEN 'N/D' THEN 'ND' END) AS TIPO_DOCUMENTO,
   DCC.DOCUMENTO,
   '00001',
   '1',
   '1',
  -- DCC.SUBTOTAL,
   CASE WHEN IMP.CALCULO_IMP2 = 'I' THEN ISNULL( DCC.MONTO / (1 + (IMP.IMPUESTO1/ 100 + IMP.IMPUESTO2/ 100 + IMP.IMPUESTO1/ 100 * IMP.IMPUESTO2/ 100) ), DCC.MONTO)
		ELSE ISNULL( ((DCC.MONTO / (1 + ((IMP.IMPUESTO1 + IMP.IMPUESTO2 ) / 100 )))+ DCC.DESCUENTO),DCC.MONTO) END  AS PRECIO_UNITARIO,
   DCC.SUBTOTAL AS PRECIO_UNITARIO_DESCONTADO,

   CASE WHEN IMP.CALCULO_IMP2 = 'I' THEN ISNULL(DCC.MONTO / (1 + (IMP.IMPUESTO1/ 100 + IMP.IMPUESTO2/ 100 + IMP.IMPUESTO1/ 100 * IMP.IMPUESTO2/ 100) ),DCC.MONTO)
	ELSE ISNULL(((DCC.MONTO / (1 + ((IMP.IMPUESTO1 + IMP.IMPUESTO2 ) / 100 ))) ),DCC.MONTO) END AS PRECIO_UNITARIO_DESC_TOTAL,  
		        
   '0.000000' AS PORCENTAJE_DESC,
   DCC.DESCUENTO AS DESC_TOT_LINEA, 
   '0.000000' AS PORCENTAJE_DESC_GENERAL_TOTAL, 
   DCC.DESCUENTO,
   IMP.IMPUESTO,     
   IMP.IMPUESTO1,
   --DCC.IMPUESTO1,
   CASE WHEN IMP.CALCULO_IMP2 = 'I' THEN ISNULL((DCC.MONTO / (1 + (IMP.IMPUESTO1/ 100 + IMP.IMPUESTO2/ 100 + IMP.IMPUESTO1/ 100 * IMP.IMPUESTO2/ 100) )) * (IMP.IMPUESTO1/100) ,0)
   ELSE ISNULL((((DCC.MONTO / (1 + ((IMP.IMPUESTO1 + IMP.IMPUESTO2 ) / 100 )))) * (IMP.IMPUESTO1 / 100 ) ),0) END AS IMPUESTO1,
   IMP.IMPUESTO2,
   --DCC.IMPUESTO2,
   
   CASE 
	   WHEN IMP.USA_IMPUESTO2_CANTIDAD = 'S' THEN ISNULL(DCC.IMPUESTO2  ,0)
	   WHEN IMP.CALCULO_IMP2 = 'S' THEN ISNULL((((DCC.MONTO / (1 + ((IMP.IMPUESTO1 + IMP.IMPUESTO2 ) / 100 )))) * (IMP.IMPUESTO2 / 100 ) ),0)
	   WHEN IMP.CALCULO_IMP2 = 'I' THEN ISNULL(((DCC.MONTO / (1 + (IMP.IMPUESTO1/ 100 + IMP.IMPUESTO2/ 100 + IMP.IMPUESTO1/ 100 * IMP.IMPUESTO2/ 100) ))- DCC.DESCUENTO) *(IMP.IMPUESTO2),0)
	   ELSE 0
	   END AS IMPUESTO2,

	 '99' CODIGO_EXENTO,
	 'Ministerio de Hacienda' NOMBRE_INSTITUCION,
    '1' NUMERO_EXENTO ,  
	'' EXENTO_FECHA,
   IMP.IMPUESTO1 * (1 + ((C.EXENCION_IMP1 - 100)/100 )) AS EXENTO_IMP1 ,
     C.EXENCION_IMP1 PORCENTAJE_EXENTO ,      
	DCC.SUBTOTAL * (C.EXENCION_IMP1 * IMP.IMPUESTO1) / 100 AS TOTAL_EXONERADO,

   DCC.SUBTOTAL AS PRECIO_TOTAL_BRUTO,
   DCC.MONTO AS PRECIO_TOTAL,
   DCC.SUBTOTAL AS PRECIO_TOTAL_DESCONTADO,
   DCC.MONTO AS PRECIO_TOTAL_NETO,
   DCC.MONTO AS PRECIO_TOTAL_NETO_GRABADO_IMP1,
   '0.000000',
   '1',
   'N' AS TIPO_LINEA_KIT,
   '1',
   DCC.FECHA,           
   'NO DEFINIDO' ADUANA_DESCRIPCION,     
   'SIN COMENTARIOS',
   DCC.APLICACION AS DESCRIPCION_LINEA,
   'ND',
   'ND',
   'ND',
   '0.000000',
   '0.000000',  
   DCC.APLICACION AS DESCRIPCION_ARTICULO,    
   '00000000000000' AS CODIGO_BARRAS_INVT,
   '00000000000000' AS CODIGO_BARRAS_VENT,
   '1.000000',
   'UND',
   'UND',
   'UND',
   'Unid' U_FEUNIDAD ,
   'U', 
   'ND',        
   'S' IMPUESTO_AGRUPABLE,
   'S' AS TIPO_SERVICIO,
   'S' AS LINEA_AGRUPABLE
  FROM $$COMPANIA$$.DOCUMENTOS_CC DCC
    LEFT JOIN $$COMPANIA$$.IMPUESTO IMP ON DCC.CODIGO_IMPUESTO = IMP.IMPUESTO
	 LEFT JOIN $$COMPANIA$$.CLIENTE C ON C.CLIENTE = DCC.CLIENTE_ORIGEN

    WHERE 0 = (SELECT COUNT(*) FROM $$COMPANIA$$.FACTURA FAC
			WHERE DCC.DOCUMENTO = FAC.FACTURA
			AND FAC.TIPO_DOCUMENTO =(CASE DCC.TIPO WHEN 'FAC' THEN 'F' WHEN 'N/C' THEN 'D' WHEN 'N/D' THEN 'ND' END));


CREATE VIEW $$COMPANIA$$.V_COMPANIA
AS 
  SELECT CON.CONJUNTO, 
         CON.NIT, 
         CON.NOMBRE, 
         CON.UBICACION, 
         CON.DIREC1, 
         CON.DIREC2, 
		 CON.DIREC3,
		 CON.COD_POSTAL,
         CON.TELEFONO, 
         CON.EMAIL_DOC_ELECTRONICO, 
         CON.PAIS, 
         CON.GLN, 
		 CON.DIVISION_GEOGRAFICA1,
		 CON.DIVISION_GEOGRAFICA2,
		 CON.DIVISION_GEOGRAFICA3,
		 CON.DIVISION_GEOGRAFICA4,
         NIT.RAZON_SOCIAL, 
         NIT.ALIAS, 
         GLO.IMPUESTO1_DESC, 
         GLO.IMPUESTO2_DESC, 
         ISNULL(CON.DIRECCION_PAG_WEB, 'CAMPO EN BLANCO') DIRECCION_PAG_WEB, 
         (SELECT ISNULL(SUBSTRING( VALOR,0,3 ) + '-' + SUBSTRING( VALOR,4,2 ) + '-' + SUBSTRING( VALOR,7,4 ), '00-00-0000')  + ' 08:00:00' 
          FROM   ERPADMIN.GLOBALES_DE 
          WHERE   NOMBRE = '$$COMPANIA$$_FECHA_RESOLUCION')          FECHA_RESOLUCION_CR, 
         (SELECT VALOR 
          FROM   ERPADMIN.GLOBALES_DE  
          WHERE   NOMBRE = '$$COMPANIA$$_NUMERO_RESOLUCION')          NUMERO_RESOLUCION_CR, 
         GF.COND_PAGO_CONTAD, 
         GF.PRECIOS_DEC 
  FROM   ERPADMIN.CONJUNTO CON, 
         $$COMPANIA$$.NIT NIT, 
         $$COMPANIA$$.GLOBALES_AS GLO, 
         $$COMPANIA$$.GLOBALES_FA GF 
  WHERE  CON.CONJUNTO = '$$COMPANIA$$' 
         AND NIT.NIT = CON.NIT ;
